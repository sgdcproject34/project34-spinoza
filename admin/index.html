<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - SSRPM</title>
  <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="../images/favicon.ico" type="image/ico" />

  <!-- Optional: keep your original CSS links if they include brand/logo assets -->
  <link href="../css/css.css" rel="stylesheet" />
  <link href="../css/custom.css" rel="stylesheet" type="text/css" />
  <link href="../css/ssrpm.css" rel="stylesheet" type="text/css" />

  <style>
    :root {
      --bg: #F5F7FB;
      --bg-soft: #EEF3FB;
      --card: #FFFFFF;
      --card-2: #FAFCFF;
      --text: #0b1220;
      --muted: #4b5874;
      --line: rgba(11,18,32,0.10);
      --primary: #4A90E2; /* Spinoza/HTH primary blue */
      --primary-600: #3b7bc4;
      --success: #50C878;
      --danger: #dc3545;
      --warning: #FFD66B;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --shadow-1: 0 6px 24px rgba(2,10,24,0.06);
      --shadow-2: 0 16px 40px rgba(2,10,24,0.08);
      --ring: 0 0 0 3px rgba(74,144,226,0.30);
      --logo-bg-url: url('../images/spinoza-logo.svg');
    }

    html, body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, #E7F0FF 0%, transparent 60%),
                  radial-gradient(1200px 900px at 110% 20%, #F2F7FF 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
      min-height: 100%;
    }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, #1a2a55 0%, transparent 60%),
                  radial-gradient(1200px 900px at 110% 20%, #123d5f 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Utility */
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .hidden { display: none !important; }

    /* Header */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(140%) blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), #7fb2f0); box-shadow: var(--shadow-1); }
    .brand-title { font-weight: 700; letter-spacing: 0.2px; }

    /* Auth card */
    .center-wrap { min-height: calc(100dvh - 72px); display: grid; place-items: center; padding: 32px 16px; }
    .auth-card {
      width: 100%; max-width: 520px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      padding: 28px;
    }
    .auth-head { display: flex; align-items: center; gap: 14px; margin-bottom: 18px; }
    .auth-icon { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, var(--primary), #7fb2f0); box-shadow: var(--shadow-1); }
    .auth-title { font-size: 22px; font-weight: 800; }
    .muted { color: var(--muted); font-size: 14px; }

    /* Inputs */
    .field { display: grid; gap: 8px; margin-top: 14px; }
    label { color: var(--muted); font-weight: 600; font-size: 13px; }
    .input {
      background: var(--card-2);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      outline: none; transition: box-shadow .15s ease, border-color .15s ease;
      width: 100%;
    }
    .input:focus { box-shadow: var(--ring); border-color: var(--primary); }

    /* Buttons */
    .btn {
      appearance: none; border: none; cursor: pointer; user-select: none; text-decoration: none;
      padding: 12px 16px; border-radius: var(--radius-md); font-weight: 700; letter-spacing: .2px;
      transition: transform .02s ease, box-shadow .15s ease, background .2s ease;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), #7fb2f0); color: #0b1220; box-shadow: var(--shadow-1); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--line); }
    .btn-danger { background: linear-gradient(135deg, #dc3545, #f16a76); color: #fff; box-shadow: var(--shadow-1); }

    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }

    /* Progress (decorative) */
    .progress-shell {
      height: 8px; background: var(--card-2); border-radius: 999px; border: 1px solid var(--line);
      overflow: hidden; margin: 10px 0 6px; position: relative;
    }
    .progress-bar { height: 100%; width: 38%; background: linear-gradient(90deg, var(--primary), #7fb2f0); }

    /* Dashboard layout */
    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 20px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.88)), var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-1);
      padding: 18px;
    }

    .dash-head { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }

    .search { display: flex; gap: 10px; }

    .list { display: grid; gap: 10px; }
    .user-item {
      background: var(--card-2); border: 1px solid var(--line); padding: 14px 14px; border-radius: var(--radius-md);
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; cursor: pointer;
      transition: border-color .15s ease, box-shadow .15s ease, transform .05s ease, background .2s ease;
    }
    .user-item:hover { box-shadow: var(--shadow-1); border-color: rgba(74,144,226,0.35); }
    .user-item.selected { outline: none; box-shadow: var(--ring); border-color: var(--primary); }
    .user-name { font-weight: 700; }
    .timestamp { color: var(--muted); font-size: 12px; }

    .details .row { display: grid; gap: 12px; }
    .detail { border-bottom: 1px dashed var(--line); padding-bottom: 10px; }
    .detail:last-child { border-bottom: 0; padding-bottom: 0; }
    .detail label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .detail .val { word-break: break-word; }

    .password-field {
      background: #0c1326; color: #0c1326; border: 1px solid var(--line);
      padding: 10px 12px; border-radius: var(--radius-sm); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      display: inline-block; min-width: 120px; user-select: none; cursor: pointer;
    }
    .password-field.revealed { color: var(--text); background: #ffffff; border-color: rgba(11,18,32,0.16); }

    .unlock { display: flex; gap: 8px; margin-top: 8px; }
    .unlock .input { padding: 10px 12px; }
    /* Subtle repeating Spinoza logo watermark */
    body::before {
      content: "";
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(74,144,226,0.08) 0, rgba(74,144,226,0) 40%),
        radial-gradient(circle at 80% 0%, rgba(80,200,120,0.06) 0, rgba(80,200,120,0) 45%),
        var(--logo-bg-url);
      background-repeat: no-repeat, no-repeat, repeat;
      background-size: 800px 800px, 900px 900px, 240px 240px; /* logo tile size */
      background-position: left -200px top -200px, right -300px top -250px, 0 0;
      opacity: 0.06; /* very subtle */
      filter: grayscale(100%);
    }

    /* PNG fallback if SVG not available */
    @supports not (background: var(--logo-bg-url)) {
      body::before { background-image:
        radial-gradient(circle at 20% 20%, rgba(74,144,226,0.08) 0, rgba(74,144,226,0) 40%),
        radial-gradient(circle at 80% 0%, rgba(80,200,120,0.06) 0, rgba(80,200,120,0) 45%),
        url('../images/spinoza-logo.png'); }
    }

</style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClpvIHEe98giJTQxO-bNbUci0i4LOmj3U",
      authDomain: "project34-baebd.firebaseapp.com",
      projectId: "project34-baebd",
      storageBucket: "project34-baebd.firebasestorage.app",
      messagingSenderId: "92418567493",
      appId: "1:92418567493:web:6d51d4af2b66ed14c3e22c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        showDashboard();
      } else {
        showLoginForm();
      }
    });

    // Login (password)
    window.loginUser = async function () {
      const email = document.getElementById('email')?.value?.trim();
      const password = document.getElementById('password')?.value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (error) { alert('Login mislukt: ' + error.message); }
    }

    // Email-link (passwordless)
    window.sendLoginLink = async function () {
      const email = document.getElementById('email')?.value?.trim();
      if (!email) { alert('Vul je email in.'); return; }
      try {
        const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Login link verzonden. Controleer je email.');
      } catch (e) { alert('Kon geen login link versturen: ' + e.message); }
    }

    // Complete sign-in if link opened
    if (isSignInWithEmailLink(auth, window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn');
      if (!email) email = window.prompt('Bevestig je email voor login');
      signInWithEmailLink(auth, email, window.location.href)
        .then(() => { window.localStorage.removeItem('emailForSignIn'); })
        .catch(err => alert('Email link login mislukt: ' + err.message));
    }

    // Login view
    function showLoginForm() {
      document.body.innerHTML = `
        <header class="topbar">
          <div class="topbar-inner">
            <div class="brand">
              <div class="brand-logo"></div>
              <div>
                <div class="brand-title">SSRPM Admin</div>
                <div class="muted">Beheerportaal • secure access</div>
              </div>
            </div>
            <div class="muted">v1.0</div>
          </div>
        </header>

        <main class="center-wrap">
          <section class="auth-card" role="dialog" aria-labelledby="auth-title">
            <div class="auth-head">
              <div class="auth-icon" aria-hidden="true"></div>
              <div>
                <h1 id="auth-title" class="auth-title">Admin Login Portal</h1>
                <p class="muted">Log in met je beheerdersaccount of ontvang een magic link.</p>
              </div>
            </div>

            <div class="progress-shell" aria-hidden="true"><div class="progress-bar"></div></div>

            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" class="input" placeholder="naam@voorbeeld.nl" autofocus />
            </div>
            <div class="field">
              <label for="password">Wachtwoord</label>
              <input id="password" type="password" class="input" placeholder="••••••••" />
            </div>
            <div class="btn-row">
              <button class="btn btn-ghost" onclick="window.location.href='https://sgdcproject34.github.io/project34-spinoza/'">Terug</button>
              <button class="btn btn-primary" onclick="loginUser()">Inloggen</button>
              <button class="btn btn-ghost" onclick="sendLoginLink()">Stuur login link</button>
            </div>
          </section>
        </main>
      `;
    }

    // Dashboard view
    async function showDashboard() {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), orderBy('timestamp', 'desc')));
        const users = [];
        usersSnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));

        const rows = users.map(u => {
          const ts = (u.timestamp && typeof u.timestamp.toDate === 'function') ? new Date(u.timestamp.toDate()) : null;
          const tsText = ts ? ts.toLocaleString() : '—';
          const name = (u.username || 'Onbekend');
          return `
            <div class="user-item" onclick="selectUser(event, '${u.id}')">
              <div class="user-name">${name}</div>
              <div class="timestamp">${tsText}</div>
            </div>`
        }).join('');

        document.body.innerHTML = `
          <header class="topbar">
            <div class="topbar-inner">
              <div class="brand">
                <div class="brand-logo"></div>
                <div>
                  <div class="brand-title">SSRPM Admin</div>
                  <div class="muted">Gebruikersbeheer</div>
                </div>
              </div>
              <div class="btn-row"><button class="btn btn-danger" onclick="logout()">Uitloggen</button></div>
            </div>
          </header>

          <main class="container">
            <div class="grid">
              <section class="card">
                <div class="dash-head">
                  <h2 style="margin:0">Gebruikers</h2>
                  <div class="search">
                    <input id="searchInput" class="input" placeholder="Zoek gebruikersnaam…" />
                  </div>
                </div>
                <div class="list" id="usersList">${rows}</div>
              </section>

              <aside class="card details" id="userDetails" style="position:sticky; top:16px; height: fit-content;">
                <div class="dash-head"><h3 style="margin:0">Details</h3></div>
                <div id="userInfo" class="row muted">Selecteer een gebruiker…</div>
              </aside>
            </div>
          </main>
        `;

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
          const q = e.target.value.toLowerCase();
          document.querySelectorAll('.user-item').forEach(el => {
            const name = el.querySelector('.user-name')?.textContent?.toLowerCase() || '';
            el.style.display = name.includes(q) ? 'grid' : 'none';
          });
        });

        // Store users globally
        window.usersData = users;
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Fout bij laden dashboard: ' + error.message);
      }
    }

    // Select user
    window.selectUser = function (ev, userId) {
      const user = window.usersData.find(u => u.id === userId);
      if (!user) return;

      document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
      ev.currentTarget.classList.add('selected');

      const userInfo = document.getElementById('userInfo');
      const ts = (user.timestamp && typeof user.timestamp.toDate === 'function') ? new Date(user.timestamp.toDate()).toLocaleString() : '—';

      userInfo.innerHTML = `
        <div class="detail"><label>Gebruikersnaam</label><div class="val">${user.username || 'Niet beschikbaar'}</div></div>
        <div class="detail">
          <label>Wachtwoord</label>
          <div class="password-field" id="password-${userId}" onclick="togglePassword('${userId}')">••••••••</div>
          <div class="unlock hidden" id="unlock-${userId}">
            <input type="password" class="input" placeholder="Code invoeren" id="unlockCode-${userId}" />
            <button class="btn btn-primary" onclick="unlockPassword('${userId}')">Ontgrendelen</button>
          </div>
        </div>
        <div class="detail"><label>VPN gebruikt</label><div class="val">${user.vpnUsed === true ? 'Ja' : (user.vpnUsed === false ? 'Nee' : 'Onbekend')}</div></div>
        <div class="detail"><label>IP-adres</label><div class="val">${user.ipAddress || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Server Locatie</label><div class="val">${user.serverLocation || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>User-Agent</label><div class="val">${user.userAgent || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Besturingssysteem</label><div class="val">${user.operatingSystem || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Schermgrootte</label><div class="val">${user.screenSize || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Taal</label><div class="val">${user.language || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Tijdzone</label><div class="val">${user.timezone || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Batterij</label><div class="val">${user.battery || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Browser History</label><div class="val">${user.browserHistory || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Timestamp</label><div class="val">${ts}</div></div>
      `;
    }

    // Toggle password field (show unlock)
    window.togglePassword = function (userId) {
      const el = document.getElementById('unlock-' + userId);
      if (!el) return;
      el.classList.toggle('hidden');
    }

    // Unlock password (DEMO: static code)
    window.unlockPassword = function (userId) {
      const code = document.getElementById('unlockCode-' + userId)?.value;
      if (code === '9461') {
        const user = window.usersData.find(u => u.id === userId);
        const field = document.getElementById('password-' + userId);
        field.textContent = user.password || 'Niet beschikbaar';
        field.classList.add('revealed');
        document.getElementById('unlock-' + userId).classList.add('hidden');
      } else {
        alert('Onjuiste code!');
      }
    }

    // Logout
    window.logout = function () { signOut(auth); }
  </script>
</head>
<body>
  <!-- Content dynamically injected by JS -->
</body>
</html>
